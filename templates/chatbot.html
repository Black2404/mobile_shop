<div id="chatbot-wrapper">
    <button id="chat-toggle" class="btn btn-primary rounded-circle shadow">
        <i class="bi bi-chat-dots-fill"></i>
    </button>

    <div id="chat-window" class="card shadow d-none">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="bi bi-robot"></i> Trợ lý bán hàng</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>
        <div id="chat-messages" class="card-body overflow-auto" style="height: 300px;">
            <div class="message bot-msg">Chào bạn! Tôi có thể giúp gì cho bạn về các sản phẩm điện thoại không?</div>
        </div>
        <div class="card-footer bg-white">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control border-0" placeholder="Nhập câu hỏi...">
                <button class="btn btn-primary" onclick="sendMessage()">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    #chatbot-wrapper { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
    #chat-toggle { width: 60px; height: 60px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
    #chat-window { width: 350px; position: absolute; bottom: 75px; right: 0; border-radius: 15px; border: none; z-index: 1001; }
    #chat-messages { display: flex; flex-direction: column; gap: 10px; background: #f8f9fa; }
    .message { padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word;}
    .bot-msg { background: #e9ecef; align-self: flex-start; color: #333; border-bottom-left-radius: 2px; }
    .user-msg { background: #0d6efd; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
</style>

<script>
    const chatWindow = document.getElementById('chat-window');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatToggle = document.getElementById('chat-toggle');

    function toggleChat() { chatWindow.classList.toggle('d-none'); }
    chatToggle.onclick = toggleChat;

    function getCookieChat(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function appendMessage(text, className, id = null) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        if(id) div.id = id;
        div.innerHTML = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        appendMessage(message, 'user-msg');
        chatInput.value = '';
        
        const loadingId = 'loading-' + Date.now();
        appendMessage('<span class="spinner-grow spinner-grow-sm" role="status"></span>', 'bot-msg', loadingId);

        try {
            const response = await fetch('/chatbot/chat/', { // Đảm bảo URL này đúng với urls.py của bạn
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookieChat('csrftoken')
                },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            document.getElementById(loadingId)?.remove();

            if (response.ok) appendMessage(data.answer, 'bot-msg');
            else appendMessage("Lỗi server, vui lòng thử lại.", 'bot-msg');
        } catch (error) {
            document.getElementById(loadingId)?.remove();
            appendMessage("Mất kết nối server.", 'bot-msg');
        }
    }

    chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>