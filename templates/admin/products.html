{% extends "admin/base.html" %}

{% block title %}Quản lý Sản phẩm{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Quản lý Sản phẩm</h1>
    <button class="btn btn-primary" onclick="openModal()">
        <i class="bi bi-plus-lg"></i> Thêm sản phẩm
    </button>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th class="ps-4">Ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Hãng</th>
                    <th>Giá</th>
                    <th>Ngày tạo</th>
                    <th class="text-end pe-4">Hành động</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                </tbody>
        </table>
    </div>
    <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center">
    <div class="small text-muted" id="pagination-info"></div>
    <nav>
        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
            </ul>
    </nav>
</div>
</div>

<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm Sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="p-id">
                    
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control" id="p-name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hãng</label>
                            <select class="form-select" id="p-brand">
                                <option value="">Đang tải...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giá</label>
                            <input type="number" class="form-control" id="p-price" required>
                        </div>
                    </div>

                    <h6 class="mt-3 mb-2 text-primary border-bottom pb-1">Thông số kỹ thuật</h6>
                    <div class="row bg-light p-2 rounded mx-1">
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">Màn hình (Screen)</label>
                            <input type="text" class="form-control form-control-sm" id="p-screen" placeholder="VD: 6.1 inch OLED">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">CPU</label>
                            <input type="text" class="form-control form-control-sm" id="p-cpu" placeholder="VD: A15 Bionic">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label small">RAM</label>
                            <input type="text" class="form-control form-control-sm" id="p-ram" placeholder="VD: 8GB">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label small">Bộ nhớ (Storage)</label>
                            <input type="text" class="form-control form-control-sm" id="p-storage" placeholder="VD: 128GB">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label small">Pin (Battery)</label>
                            <input type="text" class="form-control form-control-sm" id="p-battery" placeholder="VD: 3200mAh">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">Camera</label>
                            <input type="text" class="form-control form-control-sm" id="p-camera" placeholder="VD: 12MP + 12MP">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">Hệ điều hành (OS)</label>
                            <input type="text" class="form-control form-control-sm" id="p-os" placeholder="VD: iOS 16">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="p-desc" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh</label>
                        <input type="file" class="form-control" id="p-image">
                        <div id="img-preview" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
    
    const token = localStorage.getItem('access') 
    
    let productModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Kiểm tra đăng nhập
        if (!token) {
            alert("Bạn chưa đăng nhập! Đang chuyển hướng...");
            window.location.href = '/login/';
            return;
        }

        // Khởi tạo Modal
        const modalEl = document.getElementById('productModal');
        if (modalEl) productModal = new bootstrap.Modal(modalEl);

        loadBrands();
        loadProducts();
    });

    // 1. Load brand
    function loadBrands() {
        fetch('/api/brands/', {
            // Nếu API yêu cầu đăng nhập thì thêm header, nếu không thì bỏ dòng headers
            headers: { 'Authorization': 'Bearer ' + token } 
        })
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('p-brand');
            select.innerHTML = '<option value="">-- Chọn hãng --</option>'; // Reset
            
            // Duyệt qua danh sách hãng trả về từ DB và tạo thẻ option
            data.forEach(brand => {
                // brand.id sẽ là value gửi về server, brand.name là chữ hiển thị
                select.innerHTML += `<option value="${brand.id}">${brand.name}</option>`;
            });
        })
        .catch(err => {
            console.error("Lỗi load hãng:", err);
            document.getElementById('p-brand').innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
        });
    }

    // 2. Hàm tải danh sách sản phẩm từ API
    let currentPage = 1;

function loadProducts(page = 1) {
    currentPage = page;
    fetch(`/api/admin/products/?page=${page}`, {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        }
    })
    .then(res => {
        if (!res.ok) throw new Error("Lỗi tải dữ liệu");
        return res.json();
    })
    .then(data => {
        const tbody = document.getElementById('product-table-body');
        tbody.innerHTML = ''; 

        // Quan trọng: Dữ liệu sản phẩm nằm trong data.results
        const products = data.results; 

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">Chưa có sản phẩm nào</td></tr>';
            return;
        }

        products.forEach(p => {
            const imgSrc = p.image ? p.image : 'https://placehold.co/50x50?text=No+Img';
            const price = new Intl.NumberFormat('vi-VN').format(p.price);
            let createdDate = p.created_at ? new Date(p.created_at).toLocaleDateString('vi-VN') : '---';

            tbody.innerHTML += `
                <tr>
                    <td class="ps-4"><img src="${imgSrc}" class="rounded border" width="50" height="50"></td>
                    <td class="fw-bold">${p.name}</td>
                    <td><span class="badge bg-secondary">${p.brand_name}</span></td>
                    <td class="text-danger fw-bold">${price} đ</td>
                    <td class="text-muted small">${createdDate}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${p.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
        });

        // Gọi hàm hiển thị nút phân trang
        renderPagination(data.count, page);
    })
    .catch(err => console.error(err));
}

function renderPagination(totalItems, page) {
    const pageSize = 10;
    const totalPages = Math.ceil(totalItems / pageSize);
    const container = document.getElementById('pagination-controls');
    const info = document.getElementById('pagination-info');
    
    container.innerHTML = '';
    if (totalPages <= 1) {
        info.innerText = `Hiển thị ${totalItems} sản phẩm`;
        return;
    }

    info.innerText = `Trang ${page} / ${totalPages} (Tổng ${totalItems} sản phẩm)`;

    // Nút Trước
    container.innerHTML += `
        <li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="loadProducts(${page - 1})">Trước</a>
        </li>`;

    // Các nút số trang
    for (let i = 1; i <= totalPages; i++) {
        container.innerHTML += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="loadProducts(${i})">${i}</a>
            </li>`;
    }

    // Nút Sau
    container.innerHTML += `
        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="loadProducts(${page + 1})">Sau</a>
        </li>`;
}

    // 3. Các hàm chức năng khác 
    function openModal() {
        document.getElementById('productForm').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('img-preview').innerHTML = '';
        document.getElementById('modalTitle').innerText = 'Thêm Sản phẩm';
        productModal.show();
    }
    function saveProduct() {
        const id = document.getElementById('p-id').value;
        const fileInput = document.getElementById('p-image');
        
        const formData = new FormData();
        // Thông tin cơ bản
        formData.append('name', document.getElementById('p-name').value);
        formData.append('brand', document.getElementById('p-brand').value);
        formData.append('price', document.getElementById('p-price').value);
        formData.append('description', document.getElementById('p-desc').value);

        // Thông số kỹ thuật (Thêm mới phần này)
        formData.append('screen', document.getElementById('p-screen').value);
        formData.append('cpu', document.getElementById('p-cpu').value);
        formData.append('ram', document.getElementById('p-ram').value);
        formData.append('storage', document.getElementById('p-storage').value);
        formData.append('battery', document.getElementById('p-battery').value);
        formData.append('camera', document.getElementById('p-camera').value);
        formData.append('os', document.getElementById('p-os').value);

        // Ảnh
        if (fileInput.files[0]) {
            formData.append('image', fileInput.files[0]);
        }

        const url = id ? `/api/admin/products/${id}/` : '/api/admin/products/';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Authorization': 'Bearer ' + token }, 
            body: formData
        })
        .then(async res => {
            if (res.ok) {
                alert("Lưu thành công!");
                productModal.hide();
                loadProducts(); 
            } else {
                const err = await res.json();
                alert("Lỗi: " + JSON.stringify(err));
            }
        })
        .catch(err => alert("Lỗi kết nối!"));
    }
    
    // Hàm Delete
    function deleteProduct(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa?")) return;
        fetch(`/api/admin/products/${id}/`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (res.ok) loadProducts(); 
            else alert("Lỗi khi xóa!");
        });
    }

    // Hàm Edit (Lấy chi tiết)
    function editProduct(id) {
        // Reset form
        document.getElementById('productForm').reset();
        document.getElementById('img-preview').innerHTML = '';

        fetch(`/api/admin/products/${id}/`, {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (!res.ok) throw new Error("Không thể tải dữ liệu sản phẩm");
            return res.json();
        })
        .then(p => {
            // Điền thông tin cơ bản
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-brand').value = p.brand;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-desc').value = p.description;
            document.getElementById('p-brand').value = p.brand;
            // Điền thông số kỹ thuật (Nếu có)
            if (p.specs) {
                document.getElementById('p-screen').value = p.specs.screen || '';
                document.getElementById('p-cpu').value = p.specs.cpu || '';
                document.getElementById('p-ram').value = p.specs.ram || '';
                document.getElementById('p-storage').value = p.specs.storage || '';
                document.getElementById('p-battery').value = p.specs.battery || '';
                document.getElementById('p-camera').value = p.specs.camera || '';
                document.getElementById('p-os').value = p.specs.os || '';
            }

            // Hiển thị ảnh cũ
            if (p.thumbnail) {
                document.getElementById('img-preview').innerHTML = 
                    `<img src="${p.thumbnail}" width="100" class="rounded border mt-2">`;
            }

            document.getElementById('modalTitle').innerText = 'Cập nhật Sản phẩm';
            productModal.show();
        })
        .catch(err => alert(err.message));
    }
</script>
{% endblock %}