{% extends "admin/base.html" %}

{% block title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">Tổng quan hệ thống</h1>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm border-left-primary h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-secondary small text-uppercase fw-bold">Tổng Người dùng</div>
                        <h3 class="mb-0 fw-bold text-primary" id="stat-total">0</h3>
                    </div>
                    <div class="fs-1 text-primary opacity-25">
                        <i class="bi bi-people-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-left-success h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-secondary small text-uppercase fw-bold">Mới (30 ngày)</div>
                        <h3 class="mb-0 fw-bold text-success" id="stat-new">0</h3>
                    </div>
                    <div class="fs-1 text-success opacity-25">
                        <i class="bi bi-person-plus-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-left-info h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-secondary small text-uppercase fw-bold">Đang Hoạt động</div>
                        <h3 class="mb-0 fw-bold text-info" id="stat-active">0</h3>
                    </div>
                    <div class="fs-1 text-info opacity-25">
                        <i class="bi bi-activity"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-left-warning h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-secondary small text-uppercase fw-bold">Quản trị viên</div>
                        <h3 class="mb-0 fw-bold text-warning" id="stat-admin">0</h3>
                    </div>
                    <div class="fs-1 text-warning opacity-25">
                        <i class="bi bi-shield-lock-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0 text-dark">Danh sách tài khoản gần đây</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Họ tên</th>
                        <th>Email</th>
                        <th>Vai trò</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <tr><td colspan="5" class="text-center py-3">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .border-left-primary { border-left: 4px solid #0d6efd; }
    .border-left-success { border-left: 4px solid #198754; }
    .border-left-info    { border-left: 4px solid #0dcaf0; }
    .border-left-warning { border-left: 4px solid #ffc107; }
</style>

{% endblock %}

{% block extra_js %}
<script>
    const token = localStorage.getItem("access");

    // Khi trang load xong thì gọi 2 hàm: lấy thống kê & lấy danh sách
    document.addEventListener("DOMContentLoaded", function() {
        if (!token) window.location.href = "/login/";
        
        fetchStats();
        fetchUsers();
    });

    // 1. HÀM LẤY THỐNG KÊ
    function fetchStats() {
        fetch('/api/admin/stats/', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(data => {
            // Gán dữ liệu vào các thẻ HTML
            document.getElementById('stat-total').innerText = data.total_users;
            document.getElementById('stat-new').innerText = data.new_users_30_days;
            document.getElementById('stat-active').innerText = data.active_users;
            document.getElementById('stat-admin').innerText = data.admin_count;
        })
        .catch(err => console.error("Lỗi tải thống kê:", err));
    }

    // 2. HÀM LẤY DANH SÁCH USER (Như cũ)
    function fetchUsers() {
        fetch('/api/admin/users/', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (res.status === 401) { logout(); } // logout() từ base_admin.html
            return res.json();
        })
        .then(data => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            // Chỉ hiện tối đa 10 user mới nhất để bảng không quá dài
            const recentUsers = data.slice(0, 10); 

            recentUsers.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4">#${u.id}</td>
                        <td class="fw-bold">${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge ${u.role==='admin'?'bg-danger':'bg-secondary'}">${u.role}</span></td>
                        <td>${u.is_active ? '<span class="text-success small">● Active</span>' : '<span class="text-muted small">● Locked</span>'}</td>
                    </tr>
                `;
            });
        })
        .catch(err => console.error(err));
    }
</script>
{% endblock %}