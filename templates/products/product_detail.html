{% extends "base.html" %}
{% block content %}

<style>
    .prod-img { background:#fff; border-radius:12px; padding:20px; transition:0.3s; box-shadow:0 4px 12px #0000000d; }
    .prod-img:hover { transform: scale(1.02); }
    .star-btn { cursor:pointer; font-size:1.5rem; color:#dee2e6; transition:0.2s; }
    .star-btn.active, .star-btn:hover { color:#ffc107; transform:scale(1.1); }
    .review-box { background:#f8f9fa; border-radius:12px; padding:20px; border:1px solid #e9ecef; }
    .sticky-top-custom { position:sticky; top:20px; z-index:100; }
</style>

<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-secondary">Trang ch·ªß</a></li>
            <li class="breadcrumb-item active fw-bold" id="bread-name">ƒêang t·∫£i...</li>
        </ol>
    </nav>

    <div class="row g-5">
        <div class="col-lg-5">
            <div class="prod-img text-center">
                <img id="img" src="https://placehold.co/400" class="img-fluid" style="max-height:400px; object-fit:contain" onerror="this.src='https://placehold.co/400'">
            </div>
        </div>
        <div class="col-lg-7">
            <h1 id="name" class="fw-bolder mb-2">...</h1>
            
            <div class="mb-3">
                <span class="badge bg-warning text-dark me-2">B√°n ch·∫°y</span>
                <span class="text-muted small">ID: #{{ product_id }}</span>
            </div>
            
            <h2 class="text-danger fw-bold mb-4" id="price">...</h2>
            
            <div class="p-3 bg-white border rounded shadow-sm mb-4">
                <p id="desc" class="mb-0 text-dark" style="white-space: pre-line;"></p>
            </div>
            
            <div class="d-flex gap-3">
                <button class="btn btn-primary flex-grow-1 py-3 rounded-pill fw-bold" onclick="addToCart()">
                    <i class="bi bi-cart-fill me-2"></i>TH√äM V√ÄO GI·ªé H√ÄNG
                </button>
            </div>
        </div>
    </div>

    <hr class="my-5 opacity-25">

    <div class="row g-5">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h4 class="mb-0 fw-bold border-start border-4 border-primary ps-3">ƒê√°nh gi√° kh√°ch h√†ng</h4>
                </div>
                <div class="card-body">
                    <div id="auth-ui" class="mb-4"></div>
                    
                    <div id="reviews">
                        <div class="text-center py-4 text-muted">ƒêang t·∫£i ƒë√°nh gi√°...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="sticky-top-custom card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-3 fw-bold">
                    <i class="bi bi-gear-fill me-2"></i>Th√¥ng s·ªë k·ªπ thu·∫≠t
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <tbody id="specs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    const pid = {{ product_id }};
    const $ = id => document.getElementById(id);
    let rating = 5;

    // --- H√ÄM L·∫§Y USER & TOKEN AN TO√ÄN ---
    function getUser() {
        try {
            const u = localStorage.getItem("user");
            return u ? JSON.parse(u) : null;
        } catch (e) { return null; }
    }

    function getHeaders() {
        const token = localStorage.getItem("access");
        return {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        };
    }

    // --- H√ÄM G·ªåI API ---
    async function fetchAPI(url, options = {}) {
        try {
            const res = await fetch(url, options);
            
            if (res.status === 401) {
                console.warn("L·ªói 401: Backend t·ª´ ch·ªëi Token.");
                alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                return "UNAUTHORIZED"; 
            }

            if (res.ok) {
                if (res.status === 204) return true;
                return await res.json();
            }
            
            // Log l·ªói chi ti·∫øt
            const errText = await res.text();
            console.error("API Error:", res.status, errText);
            return null;
        } catch (err) {
            console.error("Network Error:", err);
            return null;
        }
    }

    const getStars = (n) => Array(5).fill(0).map((_,i) => `<i class="bi bi-star${i<n?'-fill':''} text-warning"></i>`).join('');

    // --- MAIN ---
    document.addEventListener("DOMContentLoaded", () => {
        // Ki·ªÉm tra xem HTML ƒë√£ render ch∆∞a r·ªìi m·ªõi ch·∫°y logic
        if (!$("name") || !$("reviews")) {
            console.error("L·ªñI: Kh√¥ng t√¨m th·∫•y c√°c th·∫ª HTML (id='name' ho·∫∑c id='reviews'). H√£y ki·ªÉm tra l·∫°i file template.");
            return;
        }
        loadProduct();
        loadReviews();
        renderAuth();
    });

    // 1. Load s·∫£n ph·∫©m
    function loadProduct() {
        fetchAPI(`/products/api/${pid}/`).then(p => {
            if(!p) return;
            if($("name")) $("name").innerText = $("bread-name").innerText = p.name;
            if($("price")) $("price").innerText = p.price.toLocaleString('vi-VN') + " ‚Ç´";
            if($("desc")) $("desc").innerText = p.description;
            // --- S·ª¨A LOGIC HI·ªÇN TH·ªä ·∫¢NH T·∫†I ƒê√ÇY ---
            const imgEl = $("img");
            if (imgEl) {
                // ∆Øu ti√™n 1: L·∫•y ·∫£nh t·ª´ m·∫£ng 'images' (C·∫•u tr√∫c c·ªßa ProductDetailAPI)
                if (p.images && p.images.length > 0) {
                    // L·∫•y ·∫£nh ƒë·∫ßu ti√™n trong m·∫£ng, key l√† 'image_url'
                    let url = p.images[0].image_url;
                    
                    // Ki·ªÉm tra n·∫øu API ch∆∞a g·∫Øn ti·ªÅn t·ªë /static/images/ th√¨ t·ª± g·∫Øn v√†o
                    if (!url.startsWith('/static/') && !url.startsWith('http')) {
                         url = '/static/images/' + url;
                    }
                    imgEl.src = url;
                } 
                // ∆Øu ti√™n 2: N·∫øu API tr·∫£ v·ªÅ 'image' ƒë∆°n l·∫ª (Backup)
                else if (p.image) {
                    imgEl.src = p.image;
                }
            }

            const map = { screen:'M√†n h√¨nh', cpu:'Chip', ram:'RAM', storage:'B·ªô nh·ªõ', battery:'Pin', camera:'Camera', os:'HƒêH' };
            if(p.specs && $("specs")) {
                $("specs").innerHTML = Object.entries(map).map(([k, v]) => 
                    `<tr><td class="ps-3 text-muted py-2">${v}</td><td class="fw-bold py-2">${p.specs[k] || '-'}</td></tr>`
                ).join("");
            }
        });
    }

    // 2. Load ƒë√°nh gi√°
    function loadReviews() {
        const user = getUser();
        fetchAPI(`/reviews/api/?product_id=${pid}`).then(data => {
            const list = Array.isArray(data) ? data : (data?.results || []);
            
            if (!list.length) {
                if($("reviews")) $("reviews").innerHTML = `<div class="text-center py-4 bg-light rounded text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</div>`;
                return;
            }

            if($("reviews")) {
                $("reviews").innerHTML = list.map(r => {
                    const name = r.user_name || "Kh√°ch h√†ng";
                    const isOwner = user && r.user === user.id;
                    return `
                        <div class="mb-4 border-bottom pb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold fs-6 text-dark">${name}</span>
                                <small class="text-muted">${new Date(r.created_at).toLocaleDateString('vi')}</small>
                            </div>
                            <div class="mb-2 d-flex align-items-center">
                                <span class="me-2">${getStars(r.rating)}</span>
                                ${isOwner ? `<button onclick="delReview(${r.id})" class="btn btn-link text-danger p-0 ms-auto text-decoration-none small">X√≥a</button>` : ''}
                            </div>
                            <div class="text-secondary" style="white-space: pre-wrap;">${r.comment}</div>
                        </div>`;
                }).join("");
            }
        });
    }

    // 3. Render khung nh·∫≠p li·ªáu
    function renderAuth() {
        if(!$("auth-ui")) return;

        const user = getUser();
        if (!user) {
            $("auth-ui").innerHTML = `<div class="alert alert-secondary text-center">Vui l√≤ng <a href="/users/login/" class="fw-bold">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë√°nh gi√°.</div>`;
            return;
        }
        
        $("auth-ui").innerHTML = `
            <div class="review-box">
                <div class="fw-bold mb-2">üëã Ch√†o ${user.name || user.username || 'b·∫°n'}, ƒë√°nh gi√° c·ªßa b·∫°n?</div>
                <div class="mb-2">
                    ${[1,2,3,4,5].map(i => `<i class="bi bi-star-fill star-btn ${i<=rating?'active':''}" onclick="setRate(${i})"></i>`).join('')} 
                    <span id="rate-txt" class="ms-2 fw-bold small text-muted">Tuy·ªát v·ªùi</span>
                </div>
                <textarea id="txtCmt" class="form-control mb-2" rows="3" placeholder="M·ªùi b·∫°n chia s·∫ª th√™m c·∫£m nh·∫≠n..."></textarea>
                <div class="text-end">
                    <button onclick="postReview()" class="btn btn-primary rounded-pill px-4 fw-bold">G·ª≠i ƒë√°nh gi√°</button>
                </div>
            </div>`;
    }

    function setRate(n) {
        rating = n;
        const txt = ["R·∫•t t·ªá", "T·ªá", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];
        if($("rate-txt")) $("rate-txt").innerText = txt[n-1];
        document.querySelectorAll('.star-btn').forEach((e, i) => e.classList.toggle('active', i < n));
    }

    // 4. G·ª≠i ƒë√°nh gi√°
    async function postReview() {
        if(!$("txtCmt")) return;
        const comment = $("txtCmt").value;
        if (!comment) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

        // G·ªçi API
        const res = await fetchAPI('/reviews/api/', { 
            method: 'POST', 
            headers: getHeaders(), 
            body: JSON.stringify({ product: pid, comment, rating }) 
        });

        if (res === "UNAUTHORIZED") {
            // ƒê√£ alert ·ªü h√†m fetchAPI
        } else if (res) {
            $("txtCmt").value = ""; 
            setRate(5); 
            loadReviews(); 
            alert("ƒê√£ g·ª≠i ƒë√°nh gi√° th√†nh c√¥ng!");
        } else {
            alert("L·ªói khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
    }

    // 5. X√≥a ƒë√°nh gi√°
    async function delReview(id) {
        if(!confirm("X√≥a ƒë√°nh gi√°?")) return;
        
        const res = await fetchAPI(`/reviews/api/${id}/`, { 
            method: 'DELETE', 
            headers: getHeaders() 
        });
        
        if (res) loadReviews();
        else alert("L·ªói khi x√≥a ƒë√°nh gi√°.");
    }

    // 6. Th√™m v√†o gi·ªè
    async function addToCart() {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!getUser()) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua h√†ng!");
            window.location.href = "/login/";
            return;
        }
        
        // G·ªçi API th√™m gi·ªè h√†ng
        // L∆∞u √Ω: Backend ph·∫£i c√≥ URL n√†y: /carts/api/add/
        const res = await fetchAPI('/carts/api/add/', {
            method: 'POST',
            headers: getHeaders(), // T·ª± ƒë·ªông l·∫•y Token
            body: JSON.stringify({ product_id: pid, quantity: 1 })
        });

        if (res === "UNAUTHORIZED") return; // L·ªói 401 ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong fetchAPI

        if (res) {
            alert("ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng th√†nh c√¥ng!");
            // N·∫øu c√≥ icon gi·ªè h√†ng tr√™n header, b·∫°n c√≥ th·ªÉ update s·ªë l∆∞·ª£ng ·ªü ƒë√¢y
        } else {
            alert("L·ªói khi th√™m gi·ªè h√†ng! (Vui l√≤ng ki·ªÉm tra l·∫°i Server ho·∫∑c URL API)");
        }
    }
</script>
{% endblock %}